```bash
docker run --detach \
  --hostname gitlab.local \
  --name gitlab \
  --shm-size=2g \
  -p 8929:80 -p 2224:22 \
  -v /data/gitlab/config:/etc/gitlab \
  -v /data/gitlab/logs:/var/log/gitlab \
  -v /data/gitlab/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
```

## 一、--shm-size=2g 是什么？

> **设置容器内部的 /dev/shm（共享内存）大小为 2GB。**

|参数|含义|
|---|---|
|--shm-size|Docker 运行时参数，控制容器 **共享内存（Shared Memory）** 大小|
|2g|2 GB（支持 1g, 512m, 2k 等格式）|

---

## 二、/dev/shm 是什么？为什么 GitLab 需要它？

### 1. /dev/shm 是 Linux 的 **内存文件系统（tmpfs）**

- 全称：**Shared Memory**（共享内存）
- 位置：挂载在 /dev/shm
- 特点：
    - 数据**存放在内存中**，速度极快
    - **容器重启后数据丢失**
    - 多个进程可以通过它**快速交换数据**

### 2. GitLab **强烈依赖共享内存** 的场景：

|GitLab 功能|是否使用 /dev/shm|为什么需要大内存？|
|---|---|---|
|**Git 打包（pack-objects）**|是|大仓库打包时需要临时缓存对象|
|**Sidekiq（后台任务）**|是|Redis 替代方案或高并发任务|
|**PostgreSQL**|是|数据库排序、临时表|
|**Gitaly / Git RPC**|是|进程间通信|

> **如果 /dev/shm 太小 → GitLab 会报错：Cannot allocate memory 或 Git pack-objects failed**

---

## 三、默认情况是多少？为什么 GitLab 要改成 2g？

|环境|默认 /dev/shm 大小|
|---|---|
|普通 Docker 容器|**64 MB**（非常小！）|
|宿主机本身|通常是物理内存的 50%|

> **64MB 对 GitLab 来说完全不够用！**
> 
> 官方推荐：
> 
> - **最小**：256m
> - **推荐**：1g ~ 2g（你用的是 2g，完美！）